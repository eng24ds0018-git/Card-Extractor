<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visiting Card Data Extractor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-full xl:max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Visiting Card Data Extractor</h1>
            <p class="text-md text-gray-600 mt-2">Upload images of visiting cards to extract contact information.</p>
            <p class="text-sm text-blue-700 bg-blue-100 p-3 rounded-lg mt-4 inline-block">
                <strong>Pro Tip:</strong> For the most accurate results, please upload photos with 8-10 cards each, and process up to 10 photos at a time.
            </p>
        </header>

        <main>
            <!-- File Upload Section -->
            <div id="upload-container" class="bg-white p-6 rounded-lg shadow-md border-2 border-dashed border-gray-300 hover:border-blue-500 transition-all duration-300 text-center">
                <input type="file" id="image-upload" accept="image/jpeg, image/png" multiple class="hidden">
                <label for="image-upload" class="cursor-pointer">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="mt-2 text-sm text-gray-600">
                        <span class="font-semibold text-blue-600">Click to upload</span> or drag and drop
                    </p>
                    <p class="text-xs text-gray-500">PNG, JPG up to 10MB</p>
                </label>
            </div>

            <!-- Image Previews Section -->
            <div id="previews-container" class="mt-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>

            <!-- Action Buttons -->
            <div id="action-buttons" class="mt-8 text-center hidden">
                <button id="extract-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Extract Data
                </button>
                <button id="export-excel-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors duration-300 shadow-sm ml-4 hidden disabled:bg-gray-400">
                    Export to Excel
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-container" class="text-center my-8 hidden">
                <div class="loader inline-block"></div>
                <p class="text-gray-600 mt-2">Extracting data... This may take a moment.</p>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="text-center my-4 text-red-600 font-medium hidden"></div>

            <!-- Results Table -->
            <div id="results-container" class="mt-8 bg-white p-4 rounded-lg shadow-md hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Extracted Data</h2>
                <div class="overflow-x-auto">
                    <table id="results-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Designation</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mobile</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fax</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Website</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const uploadContainer = document.getElementById('upload-container');
        const imageUpload = document.getElementById('image-upload');
        const previewsContainer = document.getElementById('previews-container');
        const actionButtons = document.getElementById('action-buttons');
        const extractBtn = document.getElementById('extract-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const loadingContainer = document.getElementById('loading-container');
        const resultsContainer = document.getElementById('results-container');
        const tableBody = document.getElementById('table-body');
        const errorMessage = document.getElementById('error-message');

        let uploadedFiles = [];
        let extractedData = []; // Stores extracted card detail objects

        // --- Drag and Drop functionality ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadContainer.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadContainer.addEventListener(eventName, () => uploadContainer.classList.add('border-blue-500', 'bg-blue-50'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadContainer.addEventListener(eventName, () => uploadContainer.classList.remove('border-blue-500', 'bg-blue-50'), false);
        });

        uploadContainer.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            let dt = e.dataTransfer;
            let files = dt.files;
            handleFiles(files);
        }

        imageUpload.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            [...files].forEach(file => {
                if (file.type.startsWith('image/')) {
                    uploadedFiles.push(file);
                    previewFile(file);
                }
            });
            if (uploadedFiles.length > 0) {
                actionButtons.classList.remove('hidden');
            }
        }

        function previewFile(file) {
            let reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = function() {
                let imgContainer = document.createElement('div');
                imgContainer.classList.add('relative', 'group');
                let img = document.createElement('img');
                img.src = reader.result;
                img.classList.add('h-32', 'w-full', 'object-cover', 'rounded-md', 'shadow-sm');
                imgContainer.appendChild(img);
                
                let removeBtn = document.createElement('button');
                removeBtn.innerHTML = '&times;';
                removeBtn.classList.add('absolute', 'top-1', 'right-1', 'bg-red-600', 'text-white', 'rounded-full', 'h-6', 'w-6', 'flex', 'items-center', 'justify-center', 'font-bold', 'opacity-0', 'group-hover:opacity-100', 'transition-opacity');
                removeBtn.onclick = () => {
                    uploadedFiles = uploadedFiles.filter(f => f !== file);
                    imgContainer.remove();
                    if (uploadedFiles.length === 0) {
                        actionButtons.classList.add('hidden');
                    }
                };
                imgContainer.appendChild(removeBtn);

                previewsContainer.appendChild(imgContainer);
            }
        }

        // --- API Call and Data Extraction ---
        extractBtn.addEventListener('click', async () => {
            if (uploadedFiles.length === 0) return;

            loadingContainer.classList.remove('hidden');
            resultsContainer.classList.add('hidden');
            errorMessage.classList.add('hidden');
            tableBody.innerHTML = '';
            extractedData = [];
            extractBtn.disabled = true;
            exportExcelBtn.classList.add('hidden');

            for (const file of uploadedFiles) {
                try {
                    const base64Image = await fileToBase64(file);
                    const cards = await extractDataFromImage(base64Image); 
                    
                    if (cards && cards.length > 0) {
                        cards.forEach(cardData => {
                            extractedData.push(cardData.details);
                            renderTableRow(cardData.details);
                        });
                    }
                } catch (error) {
                    console.error('Error processing file:', file.name, error);
                    // Provide a more detailed error message for debugging
                    let detailedError = `An error occurred while processing ${file.name}.`;
                    if (error.message && error.message.includes('status:')) {
                        detailedError += ` Details: ${error.message}`;
                    } else {
                        detailedError += ' Please check the browser console for more details.';
                    }
                    errorMessage.textContent = detailedError + ' Please double-check your API key and its website restrictions.';
                    errorMessage.classList.remove('hidden');
                }
            }

            loadingContainer.classList.add('hidden');
            if (extractedData.length > 0) {
                resultsContainer.classList.remove('hidden');
                exportExcelBtn.classList.remove('hidden');
            }
            extractBtn.disabled = false;
        });

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function extractDataFromImage(base64ImageData) {
            const prompt = `
                Analyze the following image which may contain one or more business cards.
                Identify EVERY distinct business card. For EACH card, provide its bounding box coordinates (x, y, width, height) as percentages of the total image dimensions, and extract its details.
                Return the result as an array of JSON objects, with one object per card.

                Each object should contain:
                1. A 'boundingBox' object with x, y, width, height as numbers between 0 and 1.
                2. A 'details' object containing the extracted text information.

                If any text detail is not found, return an empty string for that field.
            `;

            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                           type: "OBJECT",
                           properties: {
                                boundingBox: {
                                    type: "OBJECT",
                                    properties: {
                                        x: { type: "NUMBER" },
                                        y: { type: "NUMBER" },
                                        width: { type: "NUMBER" },
                                        height: { type: "NUMBER" }
                                    }
                                },
                                details: {
                                    type: "OBJECT",
                                    properties: {
                                        companyName: { type: "STRING" },
                                        contactName: { type: "STRING" },
                                        designation: { type: "STRING" },
                                        phoneNumber: { type: "STRING" },
                                        mobileNumber: { type: "STRING" },
                                        faxNumber: { type: "STRING" },
                                        email: { type: "STRING" },
                                        website: { type: "STRING" },
                                        address: { type: "STRING" },
                                    }
                                }
                            },
                        }
                    },
                },
            };

            const apiKey = "AIzaSyBPKKcQJDmoRLpPJGbTesw83MqnXy3lvEM"; // Your API key goes here if running locally
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            let response;
            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000;

            while (attempts < maxAttempts) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                         if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const jsonText = result.candidates[0].content.parts[0].text;
                            return JSON.parse(jsonText);
                        } else {
                           throw new Error("Invalid response structure from API");
                        }
                    } else if (response.status === 429 || response.status >= 500) {
                        attempts++;
                        if (attempts >= maxAttempts) {
                           throw new Error(`API request failed after ${maxAttempts} attempts with status: ${response.status}`);
                        }
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else {
                        throw new Error(`API request failed with status: ${response.status}`);
                    }
                } catch (error) {
                    attempts++;
                    if (attempts >= maxAttempts) {
                        console.error("Error calling Gemini API after multiple retries:", error);
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
             return null;
        }

        function renderTableRow(details) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${details.companyName || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${details.contactName || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${details.designation || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${details.phoneNumber || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${details.mobileNumber || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${details.faxNumber || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${details.email || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${details.website || ''}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${details.address || ''}</td>
            `;
            tableBody.appendChild(row);
        }

        // --- Excel Export ---
        exportExcelBtn.addEventListener('click', () => {
            const dataForExcel = extractedData;
            const worksheet = XLSX.utils.json_to_sheet(dataForExcel, {
                header: ["companyName", "contactName", "designation", "phoneNumber", "mobileNumber", "faxNumber", "email", "website", "address"]
            });
            
            XLSX.utils.sheet_add_aoa(worksheet, [["Company", "Name", "Designation", "Phone", "Mobile", "Fax", "Email", "Website", "Address"]], { origin: "A1" });

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Visiting Cards");
            
            const max_width = dataForExcel.reduce((w, r) => Math.max(w, r.address?.length || 0), 10);
            worksheet["!cols"] = [ 
                { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 }, 
                { wch: 15 }, { wch: 15 }, { wch: 25 }, { wch: 25 }, { wch: max_width } 
            ];

            XLSX.writeFile(workbook, "VisitingCardData.xlsx");
        });

    </script>
</body>
</html>


